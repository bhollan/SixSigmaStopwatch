<!DOCTYPE html>
<head>
<script type="text/javascript" src="src/prefixfree.js"></script>
<script type="text/javascript" src="src/Ziggy.js"></script>
<script type="text/javascript" src="src/StopWatch.js"></script>
<script src="http://d3js.org/d3.v2.min.js?2.10.0"></script>
    
<link rel="stylesheet" href="stylesheets/stylesheet.css"/>
    
<!--
The below wall of seeming garbage is the actual encoded image for the favicon
    (yes, there are other ways of doing this, but I thought this was wicked slick)
-->
    <link href="data:image/x-icon;base64,AAABAAEAEBAAAAEACABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAACVoMEAhZWYAH6QtgBshJMANT1aAGx7pQBwe5wAeI7UADNDYwAvUloAGBsjADVHZgCPlqQAY3V5AHqAmQDu5N8AKzFJADAzPQBTWXcAT2loAKjE/wAeIDIAIiaCAGl7ggAODRUAgIecAENLYAAhKiMAVGh3AG10kQBGW1EALzlYABIRGABEYFcAX2tuAGx+lAAhK0oAW2ePADU7ZwBdbIwAhZK9AIeTtwDK0ecAV2mnAMDW/wAvPDUAY3GSAB4gKgBRZ2wALDNQAMW9xwAjNmIAcYq4AEJTVQBpc48ASo2wAH6DrABWYoEAZ3OhACUmKgASEBYAaICSAGVgaQAtPl8AVWONAFVMUgA1SkQAMEJiAEBmagA8bGoA9Pr+AIaasgAyWlkAX2+WABokJQCTp/MAGBNMAEZJUwA2YFkAj6/5AGp7ewBmd4oAR3d5AA4SFAB7ia0ANmRlAEhQXwBGW1MARH6FAD1ebgAnLI0AOGlrAEdUawA5a2gATnx/AG+FmQBeaogATmNZAFlslwCCkcUASld9AIR4jQBpdHkAe4+KAAkLEgAuPDcAOUhsADhVXQCQmbAAHCAsAFFcegBGcnQADxESAFptZQApPV4AeYm3ADM8SQBrc5oAQ1hdACIvLABWZIkAra/WACcmNQAnMiwAP2VpADlHRgAWGSEAWGmYAGlzZQCHla4AxdTqABocIQBNaVoAMUJ2AKKpvABSV2wASl1+AH6IiABZV2wALjREAEtdhwBkcJIAHCkkAD91hwBaa2AAaXSVAD9KcwAPDB8AcI3EAKi1zgARDx8AFihOABkcYACDoucAR1ZhAG54mABXZocAR2JYAFpmhwBziIAAYn25AH+QuwCFj68AWmiNADxDTQBtfqoAPlWUAEZcfABGVIgAXWmZAFBkXgB0gaoAREdQAEhtcABmcIoAc4WtADE+NgBee5kAeYeqAEFZUABRcXMAU2KFAE5tggB7jbMANUY8AGeCkwAaGWEAZ4aWAG92nABrf5wAOkhCADJNUQB2g5YAZ4G9AGWIyQBShJoAQ1NIADM1QACOfY0AkbP3AB0XSgCor9AAi5rRABAUFQBqd5cARU9pAD04QAA9UH4AOz1GAFlnjAAkKz4AcoWLACc1LwA9RFIAiJS3AE1bewByhKwAPkxYAB0lJAAVITwAQVBSADxHbQAfISoAGhZIAEJVTwBDWE8ANjhBAEhNWwBrd48AVmaKADdFRABjbG8AKTQtAJap0gBgaJAAR1aIAGR0fgAeM2AANVlTAB0dKABWcasAKTRRAHWGqgBac6gAMD45ABYWUgA5XFwATnBzAEZXTQBmepAAMTpIADRBOQBFdIgAnKn2ABsoQABXa3YAlvVaFrqYTN/ISrAt4WGf6VOToMKnjNGRrtR79JBxHJXLcCQzl+1DOTaO6PgbF9lHseJocmpcCD+bd2nEZ7ZZ+YLx24UxiCfMnNr7gMP8Cb2S8/CU6wujZHhia1s3j0i/yU+ZBX/q2CVALjpOWFX2RM4sBxRzqdYoAKLSXe58dpoVIEvH/TgOjWCyflZSRff/Jjw0oSvKHxJJ5W36b14wu4p6GKbBY7yHHbXFTUKt7LnviUEEBlQprwLXpNC4V2YDqD6D3aW3q/JuL6w15tznI551OwrNEIvedBkBvn3gIlHPbGXj1REa5MAMIZ2zEw09/oEPxjJ5RiqGqrSEHlDTXwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=" rel="icon" type="image/x-icon" />
</head>


<body onload="firstRun(true);">
    <a id="forkme_banner" href="https://github.com/bhollan/SixSigmaStopwatch">View on GitHub</a>

<script>

createStopwatch = function () {
stopwatch = new StopWatch();
};

firstRun = function (input) {
    var notRunYet = input;
};
    
    //this function 'restarts' the css animation of the top display
    //there is no native way to do this in css, so it's a bit weird
    //you have to strip the element of it's animation, and then re-apply it
    //that's basically what we're doing with the 'reset' button anyway
function resetSplitDisplay() {
    var tmr = d3.select("#splitDisplay")[0][0];  //desired object inside 1-item array within another 1-item array
    var cln = tmr.cloneNode(true);    //'true' = [deep] parameter to clone children too
    tmr.remove();
    document.getElementById("container").appendChild(cln);
};
    
var margin = {top: 10, right: 30, bottom: 30, left: 30},
    width = 985 - margin.left - margin.right,
    height = 425 - margin.top - margin.bottom;
    
var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

//    THIS CODE ADDS 'CLICK TO START/SPLIT' ON GRAPH CLICK, BUT DESIGN CHANGED
//    .on("click", function() {stopwatch.start(); redraw(stopwatch.splits);})

  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
var border = d3.select("svg").append("rect")             //border around entire svg graph area
            .attr("x", 5)
            .attr("y", 5)
            .attr("height", height + margin.top)
            .attr("width", width + margin.right)
            .style("stroke", "#000000")
            .style("fill", "none")
            .style("stroke-width", 1);
    
var x = d3.scale.linear()
            .range([ 0, width ]);
    
var y = d3.scale.linear()
            .range([ height, 0 ]);

var formatForAxis = function(d) {
            //ALL this nonsense is because the time format I want is not a built-in in D3
            //AND the padding switching is somehow not working
            //https://github.com/mbostock/d3/issues/1483
            var formatString = "";
            if (d >= 3600000) //Hours in Milliseconds = 1000*60*60 = 3,600,000
                {formatString = "%H:%M:%S";}
            else if (d >= 60000) //Minutes = 1000*60 = 60000
                {formatString = "%M:%S";}
            else if (d >= 1000) //Seconds = 1000
                {formatString = "%S.%L";}
            else //Milliseconds = 1
                {formatString = "0.%L";};
                
                formatTime = d3.time.format(formatString);
                return formatTime(new Date(2012, 0, 1, 0, 0, 0, d));
        };
    
var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom")
            .tickFormat(formatForAxis);

svg.append("g")                       //add x-axis
            .attr("class","axis")
            .call(xAxis)
            .selectAll("text")
            .attr("transform",function() {return "rotate (-65)" })
            .style("text-anchor","end");

function redraw(input) {
	
		//it doesnt make any sense to make a histogram of 2 points (0-point trimmed off in next segment)
		if (input.length < 4) {
			return;
		};
		//the histogram layout plots the '0' of the first point of the array, so slice it off 
		if (input[0] === 0) {
			input = input.slice(1, input.length);
		}; 
		
		// Formatters for counts and times (converting numbers to Dates). 
		var formatCount = d3.format(",.0f");
          
		var margin = {top : 10,	right : 50,	bottom : 30, left : 50},
			width = 960 - margin.left - margin.right,
			height = 400 - margin.top - margin.bottom;
    
		//these x and y scales are different.  x will affect how the data gets binned, so must be done first.
        //the y scale however, is based on the array of arrays that comes out of histogram(), so must be done after.
        //note that 'input' becomes 'data' but is the same data points, just arranged differently.
        //create x scale
		x.domain([ d3.min(input), d3.max(input)]).nice()
            .range([ 0, width ]);
        
        var binBandwidth = 2;  // This is a unitless cheat factor for 'rough' bins vs 'sharp' bins.  For later devlopment.
    
        var numberOfBins = Math.ceil(Math.sqrt(input.length))*binBandwidth;
    
        //create an array of arrays
		var data = d3.layout.histogram()
				.bins(x.ticks(numberOfBins))(input);
    
        //create y scale
        y.domain([ 0, d3.max(data, function(d) {return d.y;})])
            .range([ height, 0 ]);
        
        //This function will highlight the table entries for the clicked bar, and the bar itself
        function barClicked(input) {
            //this is the anonymous function that barClicked returns
            return function() {
                var brightCount = d3.selectAll("#bright")[0].length;
                d3.select(this.firstChild).attr("id","bright");
                if (brightCount === d3.selectAll("#bright")[0].length) {
                    d3.select(this.firstChild).attr("id","")
                };
                d3.event.stopPropagation();
            };
        };
    
        //Bind the data for this 'click'
		var bar = svg.selectAll(".bars").
				data(data);
        
		bar.exit().remove();

		var gMan = bar.enter().append("g")
				.attr("class", "bars")
				.attr("transform", function(d) {return "translate(" + x(d.x) + "," + y(d.y) + ")";	})
                .on("click", barClicked(event));
        		
		gMan.append("rect")
				.attr("class","rects")
				.attr("x",0)
				.attr("y",0)
				.attr("width",0)
				.attr("height", 0)
                .attr("stroke-width", 1 )
                .attr("stroke", "#000000" );
    
        gMan.append("text")
                .attr("class","barheights");
    
		bar                                   //box around each bar
			.transition()
			.duration(200)
				.attr("transform", function (d) {return "translate(" + x(d.x) + "," + y(d.y) + ")"})
				.attr("height", function(d) {return height - y(d.y);});
        
        //re-bind the data so elements aren't still bound to the first 'click's data
		bar = d3.selectAll(".rects").data(data)
			.transition()
			.duration(200)
				.attr("width", function(d) {
                    return x(d.dx + x.domain()[0]);
                    })
				.attr("height", function(d) {return height - y(d.y)});
    
        bar = d3.selectAll(".barheights").data(data)
                .attr("dy", ".75em")
                .attr("y", 6)
                .attr("x", function(d) { return x(d.dx + x.domain()[0])/2;})
                .attr("text-anchor", "middle")
                .text(function(d) { return (d.y > 0) ? formatCount(d.y) : " "; });
    
        d3.select('.axis')
            .attr("transform","translate (0," + height + ")")
            .transition()
            .duration(200)
            .call(xAxis);
	};

//Generates/plots chart on pageload

createStopwatch();
function sampleGenerator() {
    var values = d3.range(1000).map(d3.random.irwinHall(11,1.2));
    return values.map(function(d) {return Math.round(d*1000)});
};
var values = sampleGenerator();
stopwatch.importTestArray(values);
redraw(stopwatch.splits);
  
    //for each bar that is selected for removal, we must remove the data from stopwatch.splits
    //removing the data in stopwatch.splits will keep the instance of stopwatch correct, and
    //the bar wil remove itself when redraw() is called once the data is removed.
function clearTimes() {
    var toClear = d3.selectAll("#bright");
        if ( toClear[0].length === 0 ) {return;} ;
    toClear.attr("id","");                                                          //remove 'bright' id
    
    var corners = toClear[0].map(function(d,i){return d.parentNode.__data__.x;})    //extract the bottom-left corner's x location
    var widths  = toClear[0].map(function(d,i){return d.parentNode.__data__.dx;})   //all the same, but the filter() will be simpler
    var limits = [corners, corners.map(function(d,i){return d + widths[i] ;})];     //formulating limits of each bar's band

    //Helper function to screen stopwatch.splits
    function checkTimes(point) {
        return limits[0].every( 
            function(d,i) {
                return !( (d <= point) && (point < limits[1][i]) )                   //lower bound inclusive to mirror d3.histogram()
            } 
        );
    };
    
    stopwatch.splits = stopwatch.splits.filter(checkTimes);
};

</script>

</body>

<title>Testing, attention please sir!</title>

<div class="container" id="container">
	<input id="start" name="controls" type="radio" onClick="stopwatch.start(); resetSplitDisplay(); firstRun(false); redraw(stopwatch.splits);" />
	<input id="stop" name="controls" type="radio" onClick="stopwatch.stop();  redraw(stopwatch.splits);" />
	<input id="reset" name="controls" type="radio" onClick="stopwatch.reset();  redraw(stopwatch.splits);" />
    <div id="timer_controls">
		<label for="start">Start / Split</label>
		<label for="stop">Stop</label>
		<label for="reset">Reset</label>
	</div>
    <div id = "clear_times" onClick="clearTimes(); redraw(stopwatch.splits);">Remove Selected<br> Bar(s)/Time(s)</div>
    <div class="timer">
		<div class="cell">
			<div class="numbers tenhour moveten">0 1 2 3 4 5 6 7 8 9</div>
		</div>
		<div class="cell">
			<div class="numbers hour moveten">0 1 2 3 4 5 6 7 8 9</div>
		</div>
		<div class="cell divider"><div class="numbers">:</div></div>
		<div class="cell">
			<div class="numbers tenminute movesix">0 1 2 3 4 5 6</div>
		</div>
		<div class="cell">
			<div class="numbers minute moveten">0 1 2 3 4 5 6 7 8 9</div>
		</div>
		<div class="cell divider"><div class="numbers">:</div></div>
		<div class="cell">
			<div class="numbers tensecond movesix">0 1 2 3 4 5 6</div>
		</div>
		<div class="cell">
			<div class="numbers second moveten">0 1 2 3 4 5 6 7 8 9</div>
		</div>
		<div class="cell divider" id="decimal"><div class="numbers">.</div></div>
 		<div class="cell">
 			<div class="numbers millisecond moveten">0 1 2 3 4 5 6 7 8 9</div>
 		</div>
		<div class="cell">
			<div class="numbers tenmillisecond moveten">0 1 2 3 4 5 6 7 8 9</div>
		</div>
		<div class="cell">
			<div class="numbers hundredmillisecond moveten">0 1 2 3 4 5 6 7 8 9</div>
		</div>
	</div>
	<!--SECONDARY TIMER FOR SPLITS-->
    <div class="timer" id = "splitDisplay" >
		<div class="cell">
			<div class="numbers tenhour moveten">0 1 2 3 4 5 6 7 8 9</div>
		</div>
		<div class="cell">
			<div class="numbers hour moveten">0 1 2 3 4 5 6 7 8 9</div>
		</div>
		<div class="cell divider"><div class="numbers">:</div></div>
		<div class="cell">
			<div class="numbers tenminute movesix">0 1 2 3 4 5 6</div>
		</div>
		<div class="cell">
			<div class="numbers minute moveten">0 1 2 3 4 5 6 7 8 9</div>
		</div>
		<div class="cell divider"><div class="numbers">:</div></div>
		<div class="cell">
			<div class="numbers tensecond movesix">0 1 2 3 4 5 6</div>
		</div>
		<div class="cell">
			<div class="numbers second moveten">0 1 2 3 4 5 6 7 8 9</div>
		</div>
		<div class="cell divider" id="decimal"><div class="numbers">.</div></div>
 		<div class="cell">
 			<div class="numbers millisecond moveten">0 1 2 3 4 5 6 7 8 9</div>
 		</div>
		<div class="cell">
			<div class="numbers tenmillisecond moveten">0 1 2 3 4 5 6 7 8 9</div>
		</div>
		<div class="cell">
			<div class="numbers hundredmillisecond moveten">0 1 2 3 4 5 6 7 8 9</div>
		</div>
	</div>
	
</div>
<!--<div class="panel panel-default">-->
<!--   Default panel contents -->
<!--  <div class="panel-heading">Panel heading</div>-->
<!---->
<!--   Table -->
<!--  <table class="table">-->
<!--    -->
<!--  </table>-->
<!--</div>-->
